# Domain Model

This document describes the core domain objects and their relationships in the Training Dynamics Workbench.

## Class Diagram

```mermaid
classDiagram
    direction TB

    class FamilyRegistry {
        -model_families_dir: Path
        -results_dir: Path
        -families: dict[str, ModelFamily]
        +get_family(name) ModelFamily
        +list_families() list[ModelFamily]
        +get_variants(family) list[Variant]
        +create_variant(family, params) Variant
    }

    class ModelFamily {
        <<protocol>>
        +name: str
        +display_name: str
        +architecture: ArchitectureSpec
        +domain_parameters: dict[str, ParameterSpec]
        +analyzers: list[str]
        +variant_pattern: str
        +create_model(params, device) HookedTransformer
        +generate_analysis_dataset(params, device) Tensor
        +generate_training_dataset(params, ...) tuple
        +prepare_analysis_context(params, device) dict
        +get_training_config() dict
    }

    class Variant {
        -family: ModelFamily
        -params: dict[str, Any]
        -results_dir: Path
        +name: str
        +state: VariantState
        +variant_dir: Path
        +checkpoints_dir: Path
        +artifacts_dir: Path
        +get_available_checkpoints() list[int]
        +load_checkpoint(epoch) state_dict
        +load_model_at_checkpoint(epoch) HookedTransformer
        +train(...) TrainingResult
    }

    class VariantState {
        <<enumeration>>
        UNTRAINED
        TRAINED
        ANALYZED
    }

    class AnalysisPipeline {
        -variant: Variant
        -config: AnalysisRunConfig
        -analyzers: list[Analyzer]
        -manifest: dict
        -results: dict
        +artifacts_dir: str
        +register(analyzer) AnalysisPipeline
        +run(force, save_every, progress_callback)
        +get_completed_epochs(analyzer_name) list[int]
        +load_artifact(analyzer_name) dict
    }

    class AnalysisRunConfig {
        <<dataclass>>
        +analyzers: list[str]
        +checkpoints: list[int] | None
    }

    class Analyzer {
        <<protocol>>
        +name: str
        +analyze(model, probe, cache, context) dict[str, ndarray]
    }

    class AnalyzerRegistry {
        -analyzers: dict[str, Analyzer]
        +register(analyzer)
        +get(name) Analyzer
        +get_for_family(family) list[Analyzer]
    }

    class ArtifactLoader {
        +variant: Variant
        +load(analyzer_name) dict
        +list_available() list[str]
    }

    class TrainingResult {
        <<dataclass>>
        +train_losses: list[float]
        +test_losses: list[float]
        +checkpoint_epochs: list[int]
        +final_train_loss: float
        +final_test_loss: float
        +variant_dir: Path
    }

    %% Relationships
    FamilyRegistry "1" --> "*" ModelFamily : discovers
    FamilyRegistry "1" --> "*" Variant : creates
    Variant "*" --> "1" ModelFamily : belongs to
    Variant "1" --> "1" VariantState : has state
    Variant "1" ..> "1" TrainingResult : produces

    AnalysisPipeline "1" --> "1" Variant : analyzes
    AnalysisPipeline "1" --> "0..1" AnalysisRunConfig : configured by
    AnalysisPipeline "1" --> "*" Analyzer : uses

    AnalyzerRegistry "1" --> "*" Analyzer : manages

    ArtifactLoader "1" --> "1" Variant : loads from

    ModelFamily ..> HookedTransformer : creates
```

## Core Concepts

### ModelFamily
A **ModelFamily** groups structurally similar models that share architecture, valid analyzers, and analysis dataset schema. Families are defined by `family.json` files in `model_families/`. The family is responsible for creating models and generating datasets.

### Variant
A **Variant** is a specific trained instance within a family, characterized by domain parameters (e.g., `prime=113, seed=42`). Each variant manages its own checkpoints and analysis artifacts directories.

### The Scientific Invariant
For meaningful analysis across training, the pipeline enforces: **same Variant + same Probe, only checkpoint varies**. This ensures all analysis outputs are directly comparable.

### Probe (Analysis Dataset)
The input tensor used for analysis forward passes. Generated by the family for a specific variant's parameters. The same probe is used across all checkpoints.

### Analyzer
Computes analysis on a single checkpoint, receiving model, probe, activation cache, and family-provided context. Returns numpy arrays that become artifacts.

### AnalysisPipeline
Orchestrates analysis across checkpoints, enforcing the Scientific Invariant. Manages artifact persistence and resumability.

## Vocabulary Evolution (Under Consideration)

| Current | Proposed | Rationale |
|---------|----------|-----------|
| `Variant` | `ModelVariant` | Clarifies it's a model instantiation |
| `Probe` | `VariantProbe` | Ties the probe to its variant |
| (epoch int) | `VariantCheckpoint` | First-class checkpoint identity |
